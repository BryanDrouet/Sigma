<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sigma - Choisir une plateforme</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="assets/icon.png" />
  <link rel="stylesheet" href="styles/styleHome.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="half left" onclick="choosePlatform('pronote')">
      <img class="logo" src="assets/logoPronote.png" alt="Logo Pronote" />
      <h2 class="h2HalfText">Acc√©der √† Pronote</h2>
    </div>
    <div class="half right" onclick="choosePlatform('ecoledirecte')">
      <img class="logo" src="assets/logoEcoleDirecte.png" alt="Logo EcoleDirecte" />
      <h2 class="h2HalfText">Acc√©der √† EcoleDirecte</h2>
    </div>
  </div>

  <button class="install-button" id="installButton">Installer l'application</button>
  <button id="showUpdatesButton">üìù</button>
  <button id="clearDataButton">üóëÔ∏è</button>

  <div id="updateModal" class="modal" style="display: none;align-items: center;justify-content: center;">
    <div class="modal-content maj">
      <span class="close" onclick="document.getElementById('updateModal').style.display='none'">&times;</span>
      <div id="updateContent" style="white-space: normal;"></div>
    </div>
  </div>

  <div id="accountModal" class="modal" style="display: none;align-items: center;justify-content: center;">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 class="popUp">Choisir un compte</h2>
      <div id="accountList"></div>
      <input type="text" id="newAccountName" placeholder="Nouveau compte" />
      <button onclick="createAccount()">Cr√©er un compte</button>
    </div>
  </div>

  <script>
    document.getElementById("clearDataButton").addEventListener("click", () => {
      if (confirm("√ätes-vous s√ªr de vouloir supprimer toutes les donn√©es enregistr√©es ? Cette action est irr√©versible.")) {
        localStorage.clear();
        alert("Toutes les donn√©es ont √©t√© supprim√©es.");
        location.reload(); 
      }
    });

    document.getElementById("showUpdatesButton").addEventListener("click", () => {
      fetch("latestMaj.md")
        .then(response => {
          if (!response.ok) throw new Error("Fichier introuvable");
          return response.text();
        })
        .then(markdown => {
          const html = marked.parse(markdown);
          document.getElementById("updateContent").innerHTML = html;
          document.getElementById("updateModal").style.display = "flex";
        })
        .catch(error => {
          document.getElementById("updateContent").innerHTML = "<p style='color:red;'>Erreur : impossible de charger les mises √† jour.</p>";
          document.getElementById("updateModal").style.display = "block";
        });
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').then(function(registration) {
        console.log('Service Worker enregistr√© avec succ√®s:', registration);
      }).catch(function(error) {
        console.log('L\'enregistrement du Service Worker a √©chou√©:', error);
      });
    }

    let deferredPrompt;
    const installButton = document.getElementById("installButton");

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installButton.style.display = "block";
    });

    installButton.addEventListener("click", () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          deferredPrompt = null;
        });
      }
    });
    
    function saveAccount(platform, accountName) {
      let accounts = JSON.parse(localStorage.getItem(platform)) || [];
      if (!accounts.includes(accountName)) {
        accounts.push(accountName);
        localStorage.setItem(platform, JSON.stringify(accounts));
      }
    }
    
    function getAccounts(platform) {
      return JSON.parse(localStorage.getItem(platform)) || [];
    }

    function showAccountList(platform) {
      const accountListDiv = document.getElementById('accountList');
      const accounts = getAccounts(platform);

      accountListDiv.innerHTML = ''; 
      accounts.forEach(account => {
        const accountItem = document.createElement('div');
        accountItem.classList.add('account-item');
        accountItem.style.display = 'flex';
        accountItem.style.alignItems = 'center';
        accountItem.style.justifyContent = 'space-between';
        accountItem.style.gap = '10px';

        const nameSpan = document.createElement('span');
        nameSpan.textContent = account;
        nameSpan.style.flex = '1';
        nameSpan.onclick = () => chooseAccount(account);

        const renameBtn = document.createElement('button');
        renameBtn.textContent = '‚úèÔ∏è';
        renameBtn.title = 'Renommer';
        renameBtn.style.paddingLeft = '12px';
        renameBtn.style.paddingRight = '12px';
        renameBtn.onclick = (e) => {
          e.stopPropagation();
          renameAccount(platform, account);
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteBtn.title = 'Supprimer';
        deleteBtn.style.paddingLeft = '12px';
        deleteBtn.style.paddingRight = '12px';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteAccount(platform, account);
        };

        accountItem.appendChild(nameSpan);
        accountItem.appendChild(renameBtn);
        accountItem.appendChild(deleteBtn);
        accountListDiv.appendChild(accountItem);
      });
    }

    function deleteAccount(platform, accountName) {
      if (!confirm(`Supprimer le compte "${accountName}" ? Toutes ses donn√©es seront perdues.`)) return;

      let accounts = getAccounts(platform);
      accounts = accounts.filter(acc => acc !== accountName);
      localStorage.setItem(platform, JSON.stringify(accounts));

      localStorage.removeItem(`${platform}_${accountName}`); // Supprime toutes les donn√©es sp√©cifiques √† ce compte

      const accountKey = `${platform}-${accountName}`;
      localStorage.removeItem(`${accountKey}-subjects`);
      localStorage.removeItem(`${accountKey}-notes`);

      showAccountList(platform);
    }

    function renameAccount(platform, oldName) {
      const newName = prompt("Entrez le nouveau nom du compte :", oldName);
      if (!newName || newName.trim() === "") return;

      let accounts = getAccounts(platform);
      if (accounts.includes(newName)) {
        alert("Un compte avec ce nom existe d√©j√†.");
        return;
      }

      // Met √† jour la liste
      accounts = accounts.map(acc => acc === oldName ? newName : acc);
      localStorage.setItem(platform, JSON.stringify(accounts));

      // Si des donn√©es associ√©es existent, on les renomme aussi
      const oldData = localStorage.getItem(`${platform}_${oldName}`);
      if (oldData) {
        localStorage.setItem(`${platform}_${newName}`, oldData);
        localStorage.removeItem(`${platform}_${oldName}`);
      }

      showAccountList(platform);
    }
    
    function chooseAccount(accountName) {
      localStorage.setItem('currentAccount', accountName);

      const platform = localStorage.getItem('currentPlatform');
      if (platform === 'pronote') {
        window.location.href = "dashboardPN.html";
      } else if (platform === 'ecoledirecte') {
        window.location.href = "dashboardED.html";
      } else {
        alert("Plateforme inconnue.");
      }
    }
    
    function createAccount() {
      const newAccountName = document.getElementById('newAccountName').value;
      if (newAccountName) {
        saveAccount(currentPlatform, newAccountName);
        chooseAccount(newAccountName); 
      } else {
        alert("Veuillez entrer un nom pour le compte.");
      }
    }
    
    function openModal(platform) {
      const title = document.querySelector('#accountModal .popUp');
      title.textContent = "Choisir un compte " + (platform === "pronote" ? "Pronote" : "Ecole Directe");
      document.getElementById("accountModal").style.display = "flex";
      showAccountList(platform); 
    }
    
    function closeModal() {
      document.getElementById("accountModal").style.display = "none";
    }

    let currentPlatform = '';

    function choosePlatform(platform) {
      currentPlatform = platform;
      localStorage.setItem('currentPlatform', platform);
      openModal(platform); 
    }
  </script>
</body>
</html>
