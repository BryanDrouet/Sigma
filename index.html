<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sigma - Choisir une plateforme</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="assets/icon.png" />
  <link rel="stylesheet" href="styles/styleHome.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="half left" onclick="choosePlatform('pronote')">
      <img class="logo" src="assets/logoPronote.png" alt="Logo Pronote" />
      <h2 class="h2HalfText">Acc√©der √† Pronote</h2>
    </div>
    <div class="half right" onclick="choosePlatform('ecoledirecte')">
      <img class="logo" src="assets/logoEcoleDirecte.png" alt="Logo EcoleDirecte" />
      <h2 class="h2HalfText">Acc√©der √† EcoleDirecte</h2>
    </div>
  </div>

  <button class="install-button" id="installButton">Installer l'application</button>
  <button id="showUpdatesButton">üìù</button>
  <button id="clearDataButton">üóëÔ∏è</button>

  <div id="updateModal" class="modal" style="display: none;align-items: center;justify-content: center;">
    <div class="modal-content maj">
      <span class="close" onclick="document.getElementById('updateModal').style.display='none'">&times;</span>
      <div id="updateContent" style="white-space: normal;"></div>
    </div>
  </div>

  <div id="accountModal" class="modal" style="display: none;align-items: center;justify-content: center;">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 class="popUp">Choisir un compte</h2>
      <label id="labelLoginAccount" style="display: none;">Se connecter :</label>
      <div id="accountList"></div>
      <h3 id="createAccountH3">Cr√©er un compte :</h3>
      <label>Nom du compte</label>
      <input type="text" id="newAccountName" placeholder="Nouveau compte" />
      <label>Type de compte</label>
      <select id="accountPeriod">
        <option value="trimestriel">Trimestriel</option>
        <option value="semestriel">Semestriel</option>
      </select>
      <button id="createAccountBtn" onclick="createAccount()">Cr√©er un compte</button>
    </div>
  </div>

  <div id="editAccountModal" class="modal" style="display: none;align-items: center;justify-content: center;">
    <div class="modal-content">
      <span class="close" onclick="closeEditModal()">&times;</span>
      <h2 class="popUp">Modifier le compte</h2>
      <label>Nom du compte</label>
      <input type="text" id="editAccountName" placeholder="Nom du compte" />
      <label>Type de compte</label>
      <select id="editAccountPeriod">
        <option value="trimestriel">Trimestriel</option>
        <option value="semestriel">Semestriel</option>
      </select>
      <button id="editAccountBtn" onclick="saveEditedAccount()">Enregistrer</button>
    </div>
  </div>

  <script>
    document.getElementById("clearDataButton").addEventListener("click", () => {
      if (confirm("√ätes-vous s√ªr de vouloir supprimer toutes les donn√©es enregistr√©es ? Cette action est irr√©versible.")) {
        localStorage.clear();
        alert("Toutes les donn√©es ont √©t√© supprim√©es.");
        location.reload(); 
      }
    });

    document.getElementById("showUpdatesButton").addEventListener("click", () => {
      fetch("latestMaj.md")
        .then(response => {
          if (!response.ok) throw new Error("Fichier introuvable");
          return response.text();
        })
        .then(markdown  => {
          const html = marked.parse(markdown);
          document.getElementById("updateContent").innerHTML = html;
          document.getElementById("updateModal").style.display = "flex";
        })
        .catch(error => {
          document.getElementById("updateContent").innerHTML = "<p style='color:red;'>Erreur : impossible de charger les mises √† jour.</p>";
          document.getElementById("updateModal").style.display = "block";
        });
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').then(function(registration) {
        console.log('Service Worker enregistr√© avec succ√®s:', registration);
      }).catch(function(error) {
        console.log('L\'enregistrement du Service Worker a √©chou√©:', error);
      });
    }

    let deferredPrompt;
    const installButton = document.getElementById("installButton");

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installButton.style.display = "block";
    });

    installButton.addEventListener("click", () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          deferredPrompt = null;
        });
      }
    });
    
    function saveAccount(platform, accountName) {
      let accounts = JSON.parse(localStorage.getItem(platform)) || [];
      if (!accounts.includes(accountName)) {
        accounts.push(accountName);
        localStorage.setItem(platform, JSON.stringify(accounts));
      }
    }
    
    function getAccounts(platform) {
      return JSON.parse(localStorage.getItem(platform)) || [];
    }

    function showAccountList(platform) {
      const accountListDiv = document.getElementById('accountList');
      const labelLoginAccount = document.getElementById('labelLoginAccount');
      const accounts = getAccounts(platform);

      accountListDiv.innerHTML = ''; 
      accounts.forEach(account => {
        labelLoginAccount.style.display = "block";
        const accountItem = document.createElement('div');
        accountItem.classList.add('account-item');
        accountItem.style.display = 'flex';
        accountItem.style.alignItems = 'center';
        accountItem.style.justifyContent = 'space-between';
        accountItem.style.gap = '10px';

        const nameSpan = document.createElement('span');
        nameSpan.textContent = account;
        nameSpan.style.flex = '1';
        nameSpan.onclick = () => chooseAccount(account);

        const renameBtn = document.createElement('button');
        renameBtn.textContent = '‚úèÔ∏è';
        renameBtn.title = 'Renommer';
        renameBtn.style.paddingLeft = '12px';
        renameBtn.style.paddingRight = '12px';
        renameBtn.onclick = (e) => {
          e.stopPropagation();
          renameAccount(platform, account);
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteBtn.title = 'Supprimer';
        deleteBtn.style.paddingLeft = '12px';
        deleteBtn.style.paddingRight = '12px';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteAccount(platform, account);
        };

        accountItem.appendChild(nameSpan);
        accountItem.appendChild(renameBtn);
        accountItem.appendChild(deleteBtn);
        accountListDiv.appendChild(accountItem);
      });
    }

    function deleteAccount(platform, accountName) {
      if (!confirm(`Supprimer le compte "${accountName}" ? Toutes ses donn√©es seront perdues.`)) return;

      let accounts = getAccounts(platform);
      accounts = accounts.filter(acc => acc !== accountName);
      localStorage.setItem(platform, JSON.stringify(accounts));

      localStorage.removeItem(`${platform}_${accountName}`); // Supprime toutes les donn√©es sp√©cifiques √† ce compte

      const accountKey = `${platform}-${accountName}`;
      localStorage.removeItem(`${accountKey}-subjects`);
      localStorage.removeItem(`${accountKey}-notes`);

      showAccountList(platform);
    }

    function renameAccount(platform, oldName) {
      platformBeingEdited = platform;
      accountBeingEdited = oldName;

      const key = `${platform}_${oldName}`;
      const data = JSON.parse(localStorage.getItem(key)) || { period: 'trimestriel' };

      document.getElementById('editAccountName').value = oldName;
      document.getElementById('editAccountPeriod').value = data.period || 'trimestriel';

      document.getElementById('editAccountModal').style.display = 'flex';
    }

    function closeEditModal() {
      document.getElementById('editAccountModal').style.display = 'none';
    }

    function saveEditedAccount() {
      const newName = document.getElementById('editAccountName').value.trim();
      const newPeriod = document.getElementById('editAccountPeriod').value;

      if (!newName) {
        alert("Le nom du compte ne peut pas √™tre vide.");
        return;
      }

      const accounts = getAccounts(platformBeingEdited);
      if (accounts.includes(newName) && newName !== accountBeingEdited) {
        alert("Un compte avec ce nom existe d√©j√†.");
        return;
      }

      // Mise √† jour de la liste
      const updatedAccounts = accounts.map(acc => acc === accountBeingEdited ? newName : acc);
      localStorage.setItem(platformBeingEdited, JSON.stringify(updatedAccounts));

      const oldKey = `${platformBeingEdited}_${accountBeingEdited}`;
      const newKey = `${platformBeingEdited}_${newName}`;
      const data = JSON.parse(localStorage.getItem(oldKey)) || {};
      localStorage.setItem(newKey, JSON.stringify({ ...data, period: newPeriod }));

      if (newKey !== oldKey) {
        localStorage.removeItem(oldKey);

        // Renommer les sous-cl√©s √©ventuelles
        const oldSubjects = localStorage.getItem(`${platformBeingEdited}-${accountBeingEdited}-subjects`);
        const oldNotes = localStorage.getItem(`${platformBeingEdited}-${accountBeingEdited}-notes`);
        if (oldSubjects) {
          localStorage.setItem(`${platformBeingEdited}-${newName}-subjects`, oldSubjects);
          localStorage.removeItem(`${platformBeingEdited}-${accountBeingEdited}-subjects`);
        }
        if (oldNotes) {
          localStorage.setItem(`${platformBeingEdited}-${newName}-notes`, oldNotes);
          localStorage.removeItem(`${platformBeingEdited}-${accountBeingEdited}-notes`);
        }
      }

      closeEditModal();
      showAccountList(platformBeingEdited);
    }
    
    function chooseAccount(accountName) {
      localStorage.setItem('currentAccount', accountName);

      const platform = localStorage.getItem('currentPlatform');
      if (platform === 'pronote') {
        window.location.href = "dashboardPN.html";
      } else if (platform === 'ecoledirecte') {
        window.location.href = "dashboardED.html";
      } else {
        alert("Plateforme inconnue.");
      }
    }
    
    function createAccount() {
      const newAccountName = document.getElementById('newAccountName').value.trim();
      const period = document.getElementById('accountPeriod').value;

      if (!newAccountName) {
        alert("Veuillez entrer un nom pour le compte.");
        return;
      }

      saveAccount(currentPlatform, newAccountName);

      // Enregistre la p√©riode dans localStorage
      const accountKey = `${currentPlatform}_${newAccountName}`;
      localStorage.setItem(accountKey, JSON.stringify({
        period: period
      }));

      chooseAccount(newAccountName);
    }
    
    function openModal(platform) {
      const title = document.querySelector('#accountModal .popUp');
      title.textContent = "Choisir un compte " + (platform === "pronote" ? "Pronote" : "Ecole Directe");
      document.getElementById("accountModal").style.display = "flex";
      showAccountList(platform); 
    }
    
    function closeModal() {
      document.getElementById("accountModal").style.display = "none";
    }

    let currentPlatform = '';

    function choosePlatform(platform) {
      currentPlatform = platform;
      localStorage.setItem('currentPlatform', platform);
      openModal(platform); 
    }
  </script>
</body>
</html>
